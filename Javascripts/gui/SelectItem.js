jQuery.gui=jQuery.gui||{};(function(c){var f={},b={},e,i,a,d,h,g=c("<div>");c.gui.SelectItem={timeToTriggerRiver:150,minRiverAJAXDuration:200,riverBottomThreshold:5,keySensitivity:100,lastSearch:"",defaults:{id:"",field_id:"",multiple:false,internal:true,link:true,title:"",onSelect:false,onCancel:false},init:function(j){j=j||{};opts=c.extend(this.defaults,j);if(!opts.onSelect){opts.onSelect=c.gui.SelectItem.selectIt}i=c("#gk-link");f.submit=c("#gk-link-submit");f.url=c("#gk-url-field");f.title=c("#gk-link-title-field");f.openInNewTab=c("#gk-link-target-checkbox");f.search=c("#gk-search-field");f.type=c('input[name="search-type"]:checked');b.search=new a(c("#gk-search-results"));b.recent=new a(c("#gk-most-recent-results"));b.elements=c(".query-results",i);i.keydown(this.keydown);i.keyup(this.keyup);f.submit.click(function(k){c.gui.SelectItem.update();k.preventDefault()});c("#gk-link-cancel").click(this.cancel);c("#gk-internal-toggle").click(this.toggleInternalLinking);b.elements.bind("river-select",this.updateFields);f.search.keyup(this.searchInternalLinks);c('input[name="search-type"]',i).click(this.searchInternalLinks);this.refresh()},select:function(n,k,m){var l=c.extend(this.defaults,m||{});l.id=n;l.field_id=k;var j={id:n,action:"gui-select-item-"+n};g.dialog({autoOpen:false,title:l.title,width:480,height:"auto",modal:true,dialogClass:"wp-dialog gk-dialog",zIndex:300000});g.load(ajaxurl,j,function(){g.dialog("open");c.gui.SelectItem.init(l)});return false},refresh:function(){b.search.refresh();b.recent.refresh();c.gui.SelectItem.setDefaultValues();f.search.focus();if(!b.recent.ul.children().length){b.recent.ajax()}},cancel:function(){g.dialog("close")},update:function(){if(typeof opts.onSelect!="function"){opts.onSelect=window[opts.onSelect]}retval=opts.onSelect(h,opts);if(retval==true){g.dialog("close")}},updateFields:function(l,k,j){if(opts.link){f.url.val(k.children(".item-permalink").val());f.title.val(k.hasClass("no-title")?"":k.children(".item-title").text())}h={url:k.children(".item-permalink").val(),title:k.hasClass("no-title")?"":k.children(".item-title").text(),id:k.children(".item-id").val(),type:k.children(".item-type").val(),info:k.children(".item-info").val(),post_type:k.children(".item-post-type").val(),taxonomy:k.children(".item-taxonomy").val()};if(j&&j.type=="click"){f.search.focus()}c.gui.SelectItem.toggleSubmit()},setDefaultValues:function(){f.url.val("http://");f.title.val("");h="";this.toggleSubmit()},searchInternalLinks:function(){var k=f.search,m,j=k.val(),l=c('input[name="search-type"]:checked',i).val();if(j.length>2){b.recent.hide();b.search.show();if(c.gui.SelectItem.lastSearch==j+l){return}c.gui.SelectItem.lastSearch=j+l;m=k.siblings("img.waiting").show();b.search.change(j,l);b.search.ajax(function(){m.hide()})}else{b.search.hide();b.recent.show()}},next:function(){b.search.next();b.recent.next()},prev:function(){b.search.prev();b.recent.prev()},toggleSubmit:function(){if((opts.link&&f.url.val()!=""&&f.url.val()!="http://"&&f.title.val()!="")||h){f.submit.removeAttr("disabled")}else{f.submit.attr("disabled","true")}},keydown:function(l){var k,j=c.ui.keyCode;switch(l.which){case j.UP:k="prev";case j.DOWN:k=k||"next";clearInterval(c.gui.SelectItem.keyInterval);c.gui.SelectItem[k]();c.gui.SelectItem.keyInterval=setInterval(c.gui.SelectItem[k],c.gui.SelectItem.keySensitivity);break;default:return}l.preventDefault()},keyup:function(k){var j=c.ui.keyCode;c.gui.SelectItem.toggleSubmit();switch(k.which){case j.ESCAPE:c.gui.SelectItem.cancel();break;case j.UP:case j.DOWN:clearInterval(c.gui.SelectItem.keyInterval);break;default:return}k.preventDefault()},delayedCallback:function(l,j){var o,n,m,k;if(!j){return l}setTimeout(function(){if(n){return l.apply(k,m)}o=true},j);return function(){if(o){return l.apply(this,arguments)}m=arguments;k=this;n=true}},toggleInternalLinking:function(k){var j=c("#gk-search-panel"),n=!j.is(":visible"),l=c(window),m=g.dialog("widget");c(this).toggleClass("toggle-arrow-active",n);if(n){f.url.attr("disabled","disabled");f.title.attr("disabled","disabled");f.openInNewTab.attr("disabled","disabled")}else{f.url.removeAttr("disabled");f.title.removeAttr("disabled");f.openInNewTab.removeAttr("disabled")}m.height("auto");j.slideToggle(300,function(){f[n?"search":"url"].focus();var r=m.outerHeight(),p=l.height(),o=l.scrollTop(),t=m.offset().top,q=t+r,s=q-p;if(s>o){m.animate({top:s<t?p-r+o:o},200)}});k.preventDefault()},selectIt:function(l,k){var j=c("#"+k.field_id+"-items");var m=c("#"+k.field_id+"-toclone");if(!k.multiple){j.html(c.gui.SelectItem.prepare_element(m.clone(),l).show())}else{if(c.inArray(l.type+"|"+l.id,c.gui.SelectItem.selected(k.id))===-1){c.gui.SelectItem.prepare_element(m.clone(),l).appendTo(j).show()}}h=null;return true},prepare_element:function(o,m){var k="",q={},l,n,p,j;if(m.type=="post"||m.type=="taxonomy"){n=m.info+"("+m.type+")";p=m.title;l=m.type}else{j=f.openInNewTab.is(":checked")?1:0;m={type:"url",id:f.url.val(),url:f.url.val(),title:f.title.val(),new_window:j};l="url";p='<a href="'+m.id+'" target="_blank">'+m.title+"</a>";n=j?guiSelectItemL10n.newTab:guiSelectItemL10n.sameTab}c(".the_item",o).val(JSON.stringify(m)).removeAttr("disabled");c(".the_type",o).val(l).removeAttr("disabled");c(".title",o).html(p);c(".infos",o).html(n);o.removeAttr("id");return o},selected:function(k){var j=[];c(".items div",c("#gecka_items_selector-"+k)).each(function(){j.push(c(".the_id",this).val())});return j},remove:function(k,j){}};a=function(l,k){var j=this;this.element=l;this.ul=l.children("ul");this.waiting=l.find("#gk-link .river-waiting");this.change(k,"post");this.refresh();l.scroll(function(){j.maybeLoad()});l.delegate("li","click",function(m){j.select(c(this),m)})};c.extend(a.prototype,{refresh:function(){this.deselect();this.visible=this.element.is(":visible")},show:function(){if(!this.visible){this.deselect();this.element.show();this.visible=true}},hide:function(){this.element.hide();this.visible=false},select:function(k,n){var m,l,o,j;if(k.hasClass("unselectable")||k==this.selected){return}this.deselect();this.selected=k.addClass("selected");m=k.outerHeight();l=this.element.height();o=k.position().top;j=this.element.scrollTop();if(o<0){this.element.scrollTop(j+o)}else{if(o+m>l){this.element.scrollTop(j+o-l+m)}}this.element.trigger("river-select",[k,n,this])},deselect:function(){if(this.selected){this.selected.removeClass("selected")}this.selected=false},prev:function(){if(!this.visible){return}var j;if(this.selected){j=this.selected.prev("li");if(j.length){this.select(j)}}},next:function(){if(!this.visible){return}var j=this.selected?this.selected.next("li"):c("li:not(.unselectable):first",this.element);if(j.length){this.select(j)}},ajax:function(m){var k=this,l=this.query.page==1?0:c.gui.SelectItem.minRiverAJAXDuration,j=c.gui.SelectItem.delayedCallback(function(n,o){k.process(n,o);if(m){m(n,o)}},l);this.query.ajax(j)},change:function(j,k){if(this.query&&this._search==j&&this._type==k){return}this._search=j;this._type=k;this.query=new d(j,k);this.element.scrollTop(0)},process:function(k,o){var l="",m=true,j="",n=o.page==1;if(!k){if(n){l+='<li class="unselectable"><span class="item-title"><em>'+guiSelectItemL10n.noMatchesFound+"</em></span></li>"}}else{c.each(k,function(){j=m?"alternate":"";j+=this["title"]?"":" no-title";l+=j?'<li class="'+j+'">':"<li>";l+='<input type="hidden" class="item-id" value="'+this["id"]+'" />';l+='<input type="hidden" class="item-permalink" value="'+this["permalink"]+'" />';l+='<input type="hidden" class="item-type" value="'+this["type"]+'" />';if(this["type"]=="post"){l+='<input type="hidden" class="item-post-type" value="'+this["post_type"]+'" />'}if(this["type"]=="taxonomy"){l+='<input type="hidden" class="item-taxonomy" value="'+this["taxonomy"]+'" />'}l+='<input type="hidden" class="item-info" value="'+this["info"]+'" />';l+='<span class="item-title">';l+=this["title"]?this["title"]:guiSelectItemL10n.noTitle;l+='</span><span class="item-info">'+this["info"];if(this["type"]=="post"&&this["info"]&&this["info"].toUpperCase()!=this["post_type"].toUpperCase()){l+=" <small>("+this["post_type"]+")</small>"}l+="</span></li>";m=!m})}this.ul[n?"html":"append"](l)},maybeLoad:function(){var k=this,l=this.element,j=l.scrollTop()+l.height();if(!this.query.ready()||j<this.ul.height()-c.gui.SelectItem.riverBottomThreshold){return}setTimeout(function(){var m=l.scrollTop(),n=m+l.height();if(!k.query.ready()||n<k.ul.height()-c.gui.SelectItem.riverBottomThreshold){return}k.waiting.show();l.scrollTop(m+k.waiting.outerHeight());k.ajax(function(){k.waiting.hide()})},c.gui.SelectItem.timeToTriggerRiver)}});d=function(j,k){this.page=1;this.allLoaded=false;this.querying=false;this.search=j;this.type=k};c.extend(d.prototype,{ready:function(){return !(this.querying||this.allLoaded)},ajax:function(l){var j=this,k={action:"gui-select-item-"+opts.id,page:this.page,_ajax_select_items_nonce:c("#_ajax_select_items_nonce").val(),id:opts.id};if(this.search){k.search=this.search}if(this.type){k.type=this.type}this.querying=true;c.post(ajaxurl,k,function(m){j.page++;j.querying=false;j.allLoaded=!m;l(m,k)},"json")}})})(jQuery);